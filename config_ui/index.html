<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TrendRadar æœ¬åœ°é…ç½®ä¸­å¿ƒ</title>
    <style>
      :root {
        color-scheme: light;
        font-family: "Segoe UI", "PingFang SC", "Microsoft YaHei", sans-serif;
      }

      body {
        margin: 0;
        padding: 24px;
        background: #f5f7fb;
        color: #1f2937;
      }

      .container {
        max-width: 920px;
        margin: 0 auto;
        background: #ffffff;
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 12px 30px rgba(15, 23, 42, 0.08);
      }

      h1 {
        margin: 0 0 8px;
        font-size: 22px;
      }

      p {
        margin: 0 0 16px;
        color: #6b7280;
        font-size: 14px;
      }

      .field {
        margin-bottom: 18px;
      }

      label {
        display: block;
        font-weight: 600;
        margin-bottom: 6px;
      }

      textarea,
      input[type="text"],
      input[type="time"] {
        width: 100%;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        padding: 10px 12px;
        font-size: 14px;
        box-sizing: border-box;
      }


      button {
        border: 1px solid transparent;
        border-radius: 10px;
        padding: 10px 16px;
        font-size: 14px;
        font-weight: 600;
        line-height: 1.2;
        cursor: pointer;
        color: #ffffff;
        background: linear-gradient(135deg, #4f46e5, #4338ca);
        box-shadow: 0 6px 14px rgba(79, 70, 229, 0.24);
        transition: transform 0.16s ease, box-shadow 0.2s ease, background 0.2s ease;
      }

      button:hover {
        transform: translateY(-1px);
        box-shadow: 0 10px 20px rgba(79, 70, 229, 0.28);
        background: linear-gradient(135deg, #4338ca, #3730a3);
      }

      button:active {
        transform: translateY(0);
      }

      button:focus-visible {
        outline: 3px solid rgba(99, 102, 241, 0.35);
        outline-offset: 2px;
      }

      .secondary-btn {
        border: 1px solid #c7d2fe;
        background: #eef2ff;
        color: #3730a3;
        box-shadow: 0 4px 10px rgba(99, 102, 241, 0.12);
      }

      .secondary-btn:hover {
        background: #e0e7ff;
        box-shadow: 0 8px 16px rgba(99, 102, 241, 0.2);
      }

      .status {
        margin-top: 16px;
        padding: 12px;
        border-radius: 8px;
        background: #f3f4f6;
        font-size: 13px;
        white-space: pre-wrap;
      }

      .hint {
        font-size: 12px;
        color: #6b7280;
        margin-top: 6px;
      }

      .help-box {
        margin-top: 8px;
        padding: 10px 12px;
        border-radius: 8px;
        border: 1px solid #e5e7eb;
        background: #f8fafc;
        font-size: 12px;
        color: #475569;
        line-height: 1.6;
      }

      .help-box strong {
        color: #1f2937;
      }

      .help-list {
        margin: 8px 0 0;
        padding-left: 18px;
      }

      .help-list li {
        margin-bottom: 4px;
      }

      .suggest-row {
        display: flex;
        gap: 8px;
        margin: 10px 0;
      }

      .inline-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
      }

      .hidden {
        display: none;
      }

      select {
        width: 100%;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        padding: 10px 12px;
        font-size: 14px;
        box-sizing: border-box;
        background: #fff;
      }

      .visual-card {
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        background: #fafcff;
        padding: 14px;
      }

      .pill {
        display: inline-block;
        border-radius: 999px;
        padding: 4px 10px;
        font-size: 12px;
        margin-right: 6px;
        margin-top: 6px;
      }

      .pill-blue {
        background: #dbeafe;
        color: #1e40af;
      }

      .pill-purple {
        background: #ede9fe;
        color: #6d28d9;
      }

      .pill-emerald {
        background: #d1fae5;
        color: #065f46;
      }

      .modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(15, 23, 42, 0.45);
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 16px;
        z-index: 100;
      }

      .modal-overlay.hidden {
        display: none;
      }

      .modal-content {
        width: min(640px, 100%);
        border-radius: 14px;
        background: white;
        box-shadow: 0 20px 45px rgba(15, 23, 42, 0.25);
        padding: 18px;
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 14px;
      }

      .icon-btn {
        border: 1px solid #d1d5db;
        background: #ffffff;
        color: #475569;
        padding: 8px 12px;
        box-shadow: none;
      }

      .icon-btn:hover {
        background: #f8fafc;
      }

      .quick-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 10px;
      }

      .quick-actions button {
        background: #eef2ff;
        color: #3730a3;
        border: 1px solid #c7d2fe;
      }

      .quick-actions button:hover {
        background: #e0e7ff;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>TrendRadar æœ¬åœ°é…ç½®ä¸­å¿ƒ</h1>
      <p>è¾“å…¥ä¸€ä¸ªæˆ–å¤šä¸ªå…³é”®è¯ï¼Œè®© AI ç”Ÿæˆç”¨äºåŒ¹é…çš„æ­£åˆ™è¡¨è¾¾å¼å¹¶ä¿å­˜åˆ°é…ç½®ã€‚</p>

      <div class="field">
        <label for="intentInput">å…³é”®è¯/ä¸»é¢˜</label>
        <textarea
          id="intentInput"
          placeholder="å¯ä»¥è¾“å…¥ï¼šå•ä¸€åè¯ / å¤šä¸ªå¹¶åˆ—å…³é”®è¯"
        ></textarea>
        <div class="suggest-row">
          <button id="aiSuggestBtn" type="button" class="secondary-btn">AI ç”Ÿæˆæ­£åˆ™</button>
        </div>
        <div class="hint">AI ä¼šç”Ÿæˆå¤šè¡Œè§„åˆ™ï¼ˆç¤ºä¾‹ï¼š/è¯A|è¯B/ => ä¸»é¢˜ï¼‰ã€‚</div>
      </div>

      <div class="field">
        <label for="regexOutput">ç”Ÿæˆçš„æ­£åˆ™è¡¨è¾¾å¼ [WORD_GROUPS]</label>
        <textarea id="regexOutput" placeholder="ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®ç”Ÿæˆ"></textarea>
      </div>

      <div class="field">
        <label for="globalFilter">å…¨å±€è¿‡æ»¤ [GLOBAL_FILTER]</label>
        <textarea id="globalFilter" placeholder="è¾“å…¥ä¸æƒ³çœ‹çš„å†…å®¹æ­£åˆ™ï¼Œä¾‹å¦‚ï¼š/å¹¿å‘Š|æŠ½å¥–|ç‚¹å‡»è¿›å…¥/"></textarea>
        <div class="hint">ä¿å­˜é…ç½®ä¼šå°†è¯¥æ­£åˆ™å†™å…¥ frequency_words.txt çš„ [GLOBAL_FILTER] åŒºåŸŸã€‚</div>
      </div>

      <div class="field">
        <label>è°ƒåº¦ç³»ç»Ÿï¼ˆconfig.scheduleï¼‰</label>
        <div class="help-box">
          <strong>æ¨é€æœºåˆ¶è¯´æ˜ï¼š</strong>ç³»ç»Ÿä¼šåœ¨å½“å‰æ—¶é—´å‘½ä¸­é¢„è®¾æ—¶é—´æ®µæ—¶ï¼ŒæŒ‰å¯¹åº”é¢‘ç‡è½®è¯¢å¹¶æ¨é€ã€‚
          <ul class="help-list">
            <li><strong>enabled=trueï¼š</strong>å¼€å¯å®šæ—¶æ¨é€ï¼›<strong>enabled=falseï¼š</strong>å®Œå…¨æš‚åœæ¨é€ã€‚</li>
            <li><strong>preset=morning_eveningï¼š</strong>é‡‡ç”¨å†…ç½®çš„æ—©æ™šæ—¶æ®µç­–ç•¥ã€‚</li>
            <li><strong>preset=customï¼š</strong>æŒ‰ä½ è®¾ç½®çš„å¼€å§‹æ—¶é—´ã€ç»“æŸæ—¶é—´ã€é¢‘ç‡æ‰§è¡Œã€‚</li>
          </ul>
        </div>
        <div class="inline-grid">
          <div>
            <label for="scheduleEnabled">æ˜¯å¦å¯ç”¨</label>
            <select id="scheduleEnabled">
              <option value="true">true</option>
              <option value="false">false</option>
            </select>
          </div>
          <div>
            <label for="schedulePreset">é¢„è®¾æ¨¡æ¿</label>
            <select id="schedulePreset"></select>
          </div>
        </div>
        <div class="hint">å¯¹åº” config.yaml çš„ schedule.enabled ä¸ schedule.presetï¼ˆå¦‚ morning_eveningï¼‰ã€‚</div>
      </div>

      <div id="customPlanField" class="field hidden">
        <label>è‡ªå®šä¹‰æ¥æ”¶è®¾ç½®ï¼ˆä»…å½“é€‰æ‹©â€œcustomâ€æ—¶ç”Ÿæ•ˆï¼‰</label>
        <div class="visual-card">
          <div class="inline-grid" style="align-items: end;">
            <div>
              <div class="hint" style="margin-top: 0">æ¥æ”¶æ—¶é—´æ®µ</div>
              <div>
                <span id="customPreviewWindow" class="pill pill-blue">09:00 - 18:00</span>
              </div>
            </div>
            <div>
              <div class="hint" style="margin-top: 0">å‘é€é¢‘ç‡</div>
              <div>
                <span id="customPreviewFrequency" class="pill pill-purple">æ¯ 60 åˆ†é’Ÿ</span>
              </div>
            </div>
          </div>
          <div class="quick-actions">
            <button id="openCustomPlanModalBtn" type="button">è®¾ç½®æ—¶é—´æ®µä¸é¢‘ç‡</button>
          </div>
        </div>
        <input id="customStart" type="time" value="09:00" class="hidden" />
        <input id="customEnd" type="time" value="18:00" class="hidden" />
        <input id="customFrequency" type="text" value="60" class="hidden" />
        <div class="hint">ä½ åªéœ€è¦ç‚¹â€œè®¾ç½®æ—¶é—´æ®µä¸é¢‘ç‡â€ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨ä¿å­˜å¯¹åº”é…ç½®ã€‚</div>
      </div>

      <div class="field">
        <label>æŠ¥å‘Šä¸ AI</label>
        <div class="help-box">
          <strong>é€‰é¡¹å«ä¹‰ï¼š</strong>
          <ul class="help-list">
            <li><strong>report.mode=currentï¼š</strong>å‘é€å½“å‰å‘¨æœŸæœ€æ–°å†…å®¹ã€‚</li>
            <li><strong>report.mode=dailyï¼š</strong>æŒ‰å¤©æ±‡æ€»åæ¨é€ã€‚</li>
            <li><strong>report.mode=incrementalï¼š</strong>ä»…æ¨é€ç›¸å¯¹ä¸Šæ¬¡æ–°å¢çš„å†…å®¹ã€‚</li>
            <li><strong>ai_analysis.enabled=trueï¼š</strong>å¯¹å†…å®¹å¢åŠ  AI åˆ†æï¼›å…³é—­åä»…ä¿ç•™åŸºç¡€ä¿¡æ¯ã€‚</li>
          </ul>
        </div>
        <div class="inline-grid">
          <div>
            <label for="reportMode">report.mode</label>
            <select id="reportMode">
              <option value="current">current</option>
              <option value="daily">daily</option>
              <option value="incremental">incremental</option>
            </select>
          </div>
          <div>
            <label for="aiAnalysisEnabled">ai_analysis.enabled</label>
            <select id="aiAnalysisEnabled">
              <option value="true">true</option>
              <option value="false">false</option>
            </select>
          </div>
        </div>
      </div>

      <button id="submitBtn">ä¿å­˜é…ç½®</button>

      <div id="status" class="status">ç­‰å¾…æäº¤...</div>
    </div>

    <div id="customPlanModal" class="modal-overlay hidden">
      <div class="modal-content">
        <div class="modal-header">
          <h3 style="margin: 0; font-size: 18px;">ğŸ•’ è‡ªå®šä¹‰æ¥æ”¶è®¾ç½®</h3>
          <button id="closeCustomPlanModalBtn" type="button" class="icon-btn">å…³é—­</button>
        </div>
        <p style="margin-bottom: 12px;">åªéœ€è¦å¡«å†™è¿™ 3 ä¸ªå­—æ®µï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨è½¬æ¢ä¸ºé…ç½®ã€‚</p>
        <div class="inline-grid">
          <div>
            <label for="modalCustomStart">æ¥æ”¶å¼€å§‹æ—¶é—´</label>
            <input id="modalCustomStart" type="time" value="09:00" />
          </div>
          <div>
            <label for="modalCustomEnd">æ¥æ”¶ç»“æŸæ—¶é—´</label>
            <input id="modalCustomEnd" type="time" value="18:00" />
          </div>
        </div>
        <div style="margin-top: 12px;">
          <label for="modalCustomFrequency">å‘é€é¢‘ç‡ï¼ˆåˆ†é’Ÿï¼‰</label>
          <input id="modalCustomFrequency" type="text" value="60" placeholder="ä¾‹å¦‚ 30ï¼ˆæ¯ 30 åˆ†é’Ÿæ¨é€ï¼‰" />
        </div>
        <div class="hint">æç¤ºï¼šè‹¥å¼€å§‹æ—¶é—´å¤§äºç»“æŸæ—¶é—´ï¼ˆå¦‚ 22:00-07:00ï¼‰ï¼Œä¼šæŒ‰è·¨åˆå¤œæ—¶æ®µå¤„ç†ã€‚</div>
        <div style="display: flex; justify-content: end; gap: 8px; margin-top: 14px;">
          <button id="cancelCustomPlanBtn" type="button" class="secondary-btn">å–æ¶ˆ</button>
          <button id="applyCustomPlanBtn" type="button">åº”ç”¨è®¾ç½®</button>
        </div>
      </div>
    </div>

    <script>
      const statusEl = document.getElementById('status');
      const submitBtn = document.getElementById('submitBtn');
      const aiSuggestBtn = document.getElementById('aiSuggestBtn');
      const intentInput = document.getElementById('intentInput');
      const regexOutput = document.getElementById('regexOutput');
      const globalFilter = document.getElementById('globalFilter');
      const schedulePresetEl = document.getElementById('schedulePreset');
      const customPlanField = document.getElementById('customPlanField');
      const customPlanModal = document.getElementById('customPlanModal');

      function updateCustomPreview() {
        const start = document.getElementById('customStart').value || '09:00';
        const end = document.getElementById('customEnd').value || '18:00';
        const freq = Number.parseInt(document.getElementById('customFrequency').value, 10) || 60;
        document.getElementById('customPreviewWindow').textContent = `${start} - ${end}`;
        document.getElementById('customPreviewFrequency').textContent = `æ¯ ${freq} åˆ†é’Ÿ`;
      }

      function openCustomPlanModal() {
        document.getElementById('modalCustomStart').value = document.getElementById('customStart').value || '09:00';
        document.getElementById('modalCustomEnd').value = document.getElementById('customEnd').value || '18:00';
        document.getElementById('modalCustomFrequency').value = document.getElementById('customFrequency').value || '60';
        customPlanModal.classList.remove('hidden');
      }

      function closeCustomPlanModal() {
        customPlanModal.classList.add('hidden');
      }

      function applyCustomPlan() {
        const modalStart = document.getElementById('modalCustomStart').value;
        const modalEnd = document.getElementById('modalCustomEnd').value;
        const modalFreqRaw = document.getElementById('modalCustomFrequency').value;
        const modalFreq = Number.parseInt(modalFreqRaw, 10);
        if (!Number.isInteger(modalFreq) || modalFreq <= 0) {
          setStatus('å‘é€é¢‘ç‡è¯·å¡«å†™æ­£æ•´æ•°åˆ†é’Ÿã€‚');
          return;
        }
        document.getElementById('customStart').value = modalStart;
        document.getElementById('customEnd').value = modalEnd;
        document.getElementById('customFrequency').value = String(modalFreq);
        updateCustomPreview();
        closeCustomPlanModal();
        setStatus('å·²åº”ç”¨è‡ªå®šä¹‰è®¾ç½®ï¼Œç‚¹å‡»â€œä¿å­˜é…ç½®â€å³å¯ç”Ÿæ•ˆã€‚');
      }

      function toggleCustomField() {
        customPlanField.classList.toggle('hidden', schedulePresetEl.value !== 'custom');
      }

      async function loadCurrentConfig() {
        setStatus('æ­£åœ¨è¯»å–å½“å‰é…ç½®...');
        try {
          const res = await fetch('/api/config');
          const data = await res.json();
          if (!res.ok) {
            setStatus(`è¯»å–é…ç½®å¤±è´¥ï¼š${data.detail || 'æœªçŸ¥é”™è¯¯'}`);
            return;
          }

          regexOutput.value = data.regex || '';
          globalFilter.value = data.global_filter || '';

          const scheduleEnabled = document.getElementById('scheduleEnabled');
          const reportMode = document.getElementById('reportMode');
          const aiAnalysisEnabled = document.getElementById('aiAnalysisEnabled');

          scheduleEnabled.value = String(data.schedule?.enabled ?? true);
          schedulePresetEl.innerHTML = '';
          (data.schedule?.presets || []).forEach((preset) => {
            const option = document.createElement('option');
            option.value = preset;
            option.textContent = preset;
            schedulePresetEl.appendChild(option);
          });
          schedulePresetEl.value = data.schedule?.preset || 'morning_evening';
          reportMode.value = data.report_mode || 'current';
          aiAnalysisEnabled.value = String(data.ai_analysis_enabled ?? true);

          document.getElementById('customStart').value = data.custom_plan?.start || '09:00';
          document.getElementById('customEnd').value = data.custom_plan?.end || '18:00';
          document.getElementById('customFrequency').value = String(data.custom_plan?.frequency_minutes ?? 60);

          updateCustomPreview();
          toggleCustomField();

          setStatus('é…ç½®å·²åŠ è½½ï¼Œå¯ç›´æ¥ä¿®æ”¹åä¿å­˜ã€‚');
        } catch (err) {
          setStatus(`è¯»å–é…ç½®å¼‚å¸¸ï¼š${err.message}`);
        }
      }

      function setStatus(message) {
        statusEl.textContent = message;
      }

      aiSuggestBtn.addEventListener('click', async () => {
        const keyword = intentInput.value.trim();
        if (!keyword) {
          setStatus('è¯·å…ˆè¾“å…¥å…³é”®è¯/ä¸»é¢˜æè¿°ã€‚');
          return;
        }

        setStatus('æ­£åœ¨ç”Ÿæˆæ­£åˆ™...');
        try {
          const res = await fetch('/api/suggest', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ keyword }),
          });
          const data = await res.json();
          if (!res.ok) {
            setStatus(`AI ç”Ÿæˆå¤±è´¥ï¼š${data.detail || 'æœªçŸ¥é”™è¯¯'}`);
            return;
          }
          regexOutput.value = data.regex || '';
          setStatus('AI æ­£åˆ™ç”Ÿæˆå®Œæˆï¼Œå¯ç›´æ¥ä¿å­˜é…ç½®ã€‚');
        } catch (err) {
          setStatus(`AI ç”Ÿæˆå¼‚å¸¸ï¼š${err.message}`);
        }
      });

      submitBtn.addEventListener('click', async () => {
        const frequencyValue = Number.parseInt(document.getElementById('customFrequency').value, 10);
        if (schedulePresetEl.value === 'custom' && (!Number.isInteger(frequencyValue) || frequencyValue <= 0)) {
          setStatus('è¯·å¡«å†™æ­£ç¡®çš„å‘é€é¢‘ç‡ï¼ˆæ­£æ•´æ•°åˆ†é’Ÿï¼‰ã€‚');
          return;
        }

        const payload = {
          regex: regexOutput.value,
          global_filter: globalFilter.value,
          schedule: {
            enabled: document.getElementById('scheduleEnabled').value === 'true',
            preset: schedulePresetEl.value,
          },
          custom_plan: {
            start: document.getElementById('customStart').value,
            end: document.getElementById('customEnd').value,
            frequency_minutes: Number.isInteger(frequencyValue) ? frequencyValue : 60,
          },
          report_mode: document.getElementById('reportMode').value,
          ai_analysis_enabled: document.getElementById('aiAnalysisEnabled').value === 'true',
        };

        setStatus('æ­£åœ¨æäº¤é…ç½®...');

        try {
          const res = await fetch('/api/config', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
          });

          const data = await res.json();
          if (!res.ok) {
            setStatus(`æäº¤å¤±è´¥ï¼š${data.detail || 'æœªçŸ¥é”™è¯¯'}`);
            return;
          }
          setStatus(`æäº¤æˆåŠŸï¼š\n${JSON.stringify(data, null, 2)}`);
        } catch (err) {
          setStatus(`æäº¤å¼‚å¸¸ï¼š${err.message}`);
        }
      });

      schedulePresetEl.addEventListener('change', toggleCustomField);
      document.getElementById('openCustomPlanModalBtn').addEventListener('click', openCustomPlanModal);
      document.getElementById('closeCustomPlanModalBtn').addEventListener('click', closeCustomPlanModal);
      document.getElementById('cancelCustomPlanBtn').addEventListener('click', closeCustomPlanModal);
      document.getElementById('applyCustomPlanBtn').addEventListener('click', applyCustomPlan);
      customPlanModal.addEventListener('click', (event) => {
        if (event.target === customPlanModal) {
          closeCustomPlanModal();
        }
      });

      loadCurrentConfig();
    </script>
  </body>
</html>
